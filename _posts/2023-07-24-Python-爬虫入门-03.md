---
layout: post
title: Python-çˆ¬è™«å…¥é—¨-03
date: 2023-07-24 16:45:30.000000000 +09:00
categories: [Python, çˆ¬è™«]
tags: [Python, çˆ¬è™«]
---

# 20 Selenium

## Selenium ç®€ä»‹
* Selenium æ˜¯ä¸€ä¸ªç”¨äº web åº”ç”¨ç¨‹åºçš„æµ‹è¯•å·¥å…·
* Selenium æµ‹è¯•æµ‹è¯•ç›´æ¥è¿è¡Œåœ¨æµè§ˆå™¨ä¸­ï¼Œå°±åƒçœŸæ­£çš„ç”¨æˆ·æ“ä½œä¸€æ ·
* æ”¯æŒå„ç§ driver é©±åŠ¨çœŸå®æµè§ˆå™¨å®Œæˆæµ‹è¯•
* æ”¯æŒæ— ç•Œé¢æµè§ˆå™¨æ“ä½œ

## ä¸ºä»€ä¹ˆå­¦ä¹  Selenium
* è®© Selenium é©±åŠ¨ä¸€ä¸ªçœŸå®çš„æµè§ˆå™¨ï¼Œç„¶åç»™æˆ‘ä»¬è·å–æ•°æ®

## Selenium å®‰è£…
1. [ä¸‹è½½è°·æ­Œæµè§ˆå™¨é©±åŠ¨](http://chromedriver.storage.googleapis.com/index.html)
* ä¸‹è½½é©±åŠ¨çš„ç‰ˆæœ¬æœ€å¥½ä¸å½“å‰æµè§ˆå™¨ç‰ˆæœ¬ä¸€è‡´ï¼Œä¾‹å¦‚ `114.0.5735.248`ï¼Œä¸‹è½½ `114.0.` çš„éƒ½è¡Œã€‚æˆ–ä¸‹è½½æ›´é«˜çš„ç‰ˆæœ¬
* ä¸‹è½½åï¼Œå°†è§£å‹çš„ chromedriver å¯æ‰§è¡Œæ–‡ä»¶æ”¾åˆ°ä»£ç çˆ¬è™«ä»£ç çš„åŒçº§ç›®å½•ä¸‹
2. install selenium

```bash
$ pip3 install selenium
```

## Selenium åŸºæœ¬ä½¿ç”¨


```python
# 1 å¯¼å…¥ selenium
from selenium import webdriver

import time

# 2 åˆ›å»ºæµè§ˆå™¨æ“ä½œå¯¹è±¡
# å³ä¸‹è½½çš„ chromedriver é©±åŠ¨çš„è·¯å¾„
# path = 'chromedriver'
# print(path)

browser = webdriver.Chrome()

# 3 è®¿é—®ç½‘ç«™
url = 'https://www.com'
browser.get(url)

content = browser.page_source
print(content)

# sleep 300s é˜²æ­¢è‡ªåŠ¨å…³é—­
time.sleep(300)
```

## Selenium å…ƒç´ å®šä½
* æ¨¡æ‹Ÿé¼ æ ‡å’Œé”®ç›˜æ¥æ“ä½œè¿™äº›å…ƒç´ ï¼Œå¦‚ç‚¹å‡»ã€è¾“å…¥ç­‰ã€‚æ“ä½œè¿™äº›å…ƒç´ å‰æˆ‘ä»¬è¦å…ˆæ‰¾åˆ°ä»–ä»¬ï¼Œwebdriver æä¾›äº†å¾ˆå¤šå®šä½çš„æ–¹æ³•


```python
from selenium import webdriver
import time

url = 'https://'

browser = webdriver.Chrome()
browser.get(url)

# å…ƒç´ å®šä½

# 1 æ ¹æ® id çš„å€¼ï¼Œæ‰¾åˆ°å¯¹è±¡ ï¼ˆå¸¸ç”¨ï¼‰
# è¿™é‡Œæ˜¯æ‰¾ id å±æ€§ï¼Œvalue ä¸º su çš„å¯¹è±¡
button = browser.find_element('id', 'su')
print(button)

# 2æ ¹æ® æ ‡ç­¾çš„å±æ€§çš„å±æ€§å€¼ï¼Œæ‰¾åˆ°å¯¹è±¡
# è¿™é‡Œæ˜¯æ‰¾ name å±æ€§ï¼Œvalue ä¸º wd çš„å¯¹è±¡
button = browser.find_element('name', 'wd')
print(button)

# 3 æ ¹æ® xpath è¯­å¥è·å–å¯¹è±¡ ï¼ˆå¸¸ç”¨ï¼‰
# button = browser.find_elements('xpath', '//input[@id="su"]')[0]
button = browser.find_element('xpath', '//input[@id="su"]')
print(button)


# 4 æ ¹æ® æ ‡ç­¾åç§° è·å–å¯¹è±¡
# è¿™é‡Œè·å– input æ ‡ç­¾çš„å¯¹è±¡
button = browser.find_element('tag name', 'input')
print(button)

# 5 æ ¹æ® BeautifulSoup è¯­æ³•è·å–å¯¹è±¡ ï¼ˆå¸¸ç”¨ï¼‰
# è¿™é‡Œè·å– id=su çš„å¯¹è±¡
button = browser.find_element('css selector', '#su')
print(button)

# 6 æ ¹æ® é“¾æ¥çš„æ–‡æœ¬ è·å–å¯¹è±¡
button = browser.find_element('link text', 'è§†é¢‘')
print(button)
```

## Selenium å…ƒç´ ä¿¡æ¯

```python
from selenium import webdriver


url = 'https://w'

# options = webdriver.ChromeOptions()
# options.add_argument('--no-sandbox')

browser = webdriver.Chrome()
browser.get(url)

input_ = browser.find_element('id', 'su')

# è·å– class å±æ€§å€¼
cls = input_.get_attribute('class')
print(cls)

# è·å– æ ‡ç­¾åç§°
print(input_.tag_name)

# è·å–å…ƒç´ æ–‡æœ¬
a = browser.find_element('link text', 'æ–°é—»')
print(a.text)
```

> å¦‚æœæŠ¥é”™ `unknown error devtoolsactiveport file doesn't exist` å¯åˆ é™¤ `~/.cache/selenium` æ–‡ä»¶å¤¹å³å¯
{: .prompt-info }

## Selenium äº¤äº’


```python
from selenium import webdriver

import time

url = 'https://.com'


browser = webdriver.Chrome()
browser.get(url)


time.sleep(2)

# è·å¾—è¾“å…¥æ¡†å¯¹è±¡
input_ = browser.find_element('id', 'kw')
print(input_)

# åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥ æœç´¢çš„å…³é”®å­—
input_.send_keys('æ˜æ˜Ÿ')

time.sleep(2)

# è·å–æŒ‰é’®

button = browser.find_element('id', 'su')
# ç‚¹å‡»æŒ‰é’®
button.click()

time.sleep(2)

# æ»‘åŠ¨åˆ°åº•éƒ¨
# scrollTop æ»‘åŠ¨åˆ°åº•éƒ¨ï¼Œvalueï¼ˆè·ç¦»ï¼‰ æ˜¯ 10 ä¸‡
js_to_bottom = 'document.documentElement.scrollTop=100000'
browser.execute_script(js_to_bottom)
time.sleep(2)

# è·å–ä¸‹ä¸€é¡µæŒ‰é’®
next_btn = browser.find_element('xpath', '//a[@class="n"]')
print(f'next btn {next_btn}')
next_btn.click()

time.sleep(2)

browser.execute_script(js_to_bottom)

time.sleep(2)

# å›åˆ°ä¸Šä¸€é¡µ
browser.back()
browser.execute_script(js_to_bottom)

time.sleep(2)

# å›å»
browser.forward()
time.sleep(2)

browser.execute_script(js_to_bottom)

time.sleep(2)
```


## æ— ç•Œé¢çš„æµè§ˆå™¨
* æ”¯æŒé¡µé¢å…ƒç´ æŸ¥æ‰¾ã€js æ‰§è¡Œç­‰
* ç”±äºä¸è¿›è¡Œ css å’Œ gui æ¸²æŸ“ï¼Œæ‰€ä»¥è¿è¡Œæ•ˆç‡æ¯”çœŸå®æµè§ˆå™¨è¦å¿«
* ç›®å‰æœ‰ä¿©
1. Phantomjsï¼ˆå…¬å¸é»„äº†ğŸ¤£ï¼Œæ–°ç‰ˆæœ¬ selenium å·²ç»ä¸æ”¯æŒäº†ï¼Œå¦‚æœæƒ³ç”¨å¯ä»¥ä½¿ç”¨ä½ç‰ˆæœ¬çš„ seleniumï¼‰
2. Chrome handless (æ¨è)

### Chrome handless
* Chrome-headless æ¨¡å¼ï¼Œå¯ä»¥è®©ä½ ä¸æ‰“å¼€ UI ç•Œé¢çš„æƒ…å†µä¸‹ä½¿ç”¨ Chrome


```python
from selenium import webdriver
from selenium.webdriver.chrome.options import Options


def shared_browser():
    options = Options()
    options.add_argument('--headless')
    options.add_argument('--disable-gpu')
    # è¯•äº†ä¸€ä¸‹ä¸å†™è¿™ä¸ªä¹Ÿèƒ½ç”¨
    # chrome_options.binary_location = r'~/Applications'
    browser = webdriver.Chrome(options=options)
    return browser


browser = shared_browser()
url = ''

browser.get(url)
print('url')

browser.save_screenshot('screenshot.png')
```

# 21 Request åº“

## æ–‡æ¡£

* [å®˜æ–¹æ–‡æ¡£](https://requests.readthedocs.io/projects/cn/zh_CN/latest/)
* [å¿«é€Ÿä¸Šæ‰‹](https://requests.readthedocs.io/projects/cn/zh_CN/latest/user/quickstart.html)

## å®‰è£…

```bash
$ pip3 install requests
```


## åŸºæœ¬ä½¿ç”¨

```python
import requests


url = ''

response = requests.get(url)

# ä¸€ä¸ªç±»å‹å’Œå…­ä¸ªå±æ€§
# ç±»å‹æ˜¯ requests.models.Response
print(type(response))

# 1 è®¾ç½® response çš„ç¼–ç æ ¼å¼
response.encoding = 'utf-8'

# 2 ä»¥å­—ç¬¦ä¸²å½¢å¼è¿”å›ç½‘é¡µçš„æºç 
print(response.text)

# 3 è¿”å›è¯·æ±‚çš„ url
print(response.url)

# 4 è¿”å›çš„æ˜¯äºŒè¿›åˆ¶çš„æ•°æ®ï¼Œç”¨çš„ä¸å¤šï¼Œç”¨ text èƒ½æ›¿ä»£
print(response.content)

# 5 è¿”å›å“åº”çš„çŠ¶æ€ç 
print(response.status_code)

# 6 è¿”å› headers
print(response.headers)
```

## get è¯·æ±‚
* å‚æ•°ä½¿ç”¨ params ä¼ é€’
* å‚æ•°æ— éœ€ urlencode ç¼–ç 
* ä¸éœ€è¦è¯·æ±‚å¯¹è±¡å®šåˆ¶
* è¯·æ±‚è·¯å¾„ä¸­ query å‰çš„ ? å¯åŠ ä¹Ÿå¯ä¸åŠ 


```python
import requests
import urllib.request


url = 'https://?'

headers = {
    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac'
}

data = {
    'xx': 'åŒ—äº¬',
}

# url è¯·æ±‚è·¯å¾„
# params å³å‚æ•°
# kwargs å­—å…¸
resp = requests.get(url=url, params=data, headers=headers)

content = resp.text
print(content)
```

## post è¯·æ±‚
* post è¯·æ±‚ä¸éœ€è¦ç¼–è§£ç 
* post è¯·æ±‚çš„å‚æ•°æ˜¯ data
* ä¸éœ€è¦è¯·æ±‚å¯¹è±¡çš„å®šåˆ¶


```python
import requests


url = ''

headers = {
    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36'
}

# post è¯·æ±‚çš„å‚æ•°ï¼Œå¿…é¡»è¿›è¡Œç¼–ç ï¼Œå³å¿…é¡»ä½¿ç”¨ urlencode
data = {
    'xx': 'spider'
}

# url è¯·æ±‚åœ°å€
# data è¯·æ±‚å‚æ•°
# kwargs å­—å…¸
resp = requests.post(url=url, data=data, headers=headers)
content = resp.text
print(content)
```

## ä»£ç†

```python
import requests

url = 'http?'


headers = {
    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36'
}

data = {
    'xx': 'ip'
}

proxies = {
    'http': '182.34.102.138:9999'
}

resp = requests.get(url=url, params=data, headers=headers, proxies=proxies)
text = resp.text
print(text)
```

## cookie ç™»å½• éªŒè¯ç 

### éš¾ç‚¹
1. å¦‚ä½•æ‰¾ç™»å½•æ¥å£
* æ–¹æ³• 1ï¼šç»™ä¸€ä¸ªé”™è¯¯çš„å¯†ç ï¼Œåœ¨å¼€å‘è€…å·¥å…·ä¸­æ‰¾
* æ–¹æ³• 2ï¼šå¦‚æœ chrome ç‰ˆæœ¬è¿‡ä½ï¼Œéœ€è¦æŠŠå¼€å‘è€…å·¥å…·ä¸­ï¼Œpreserve log å‹¾ä¸Šï¼Œä¸å‹¾çš„è¯å¯èƒ½ç™»å½•åå…¶æ¥å£ log å°±è¢«åˆ é™¤äº†ã€‚ä½†å‹¾ä¸Šå¯èƒ½æ¥å£å¤ªå¤šï¼Œæ‰€ä»¥æ¨èæ–¹æ³•ä¸€
2. éšè—åŸŸï¼šç™»å½•æ¥å£ä¸­çš„ post å‚æ•°ä¸ºç½‘é¡µæºç ä¸­çš„éšè—åŸŸï¼Œç‰¹å¾ä¸ºæ ‡ç­¾çš„å±æ€§ type ä¸ºéšè—ï¼Œä¾‹å¦‚ `<input type="hidden"`
3. éªŒè¯ç ï¼šä¿è¯å§‹ç»ˆæ˜¯ä¸€ä¸ªè¯·æ±‚ï¼Œè¦ç‚¹æ˜¯ `ä½¿ç”¨åŒä¸€ä¸ªè¯·æ±‚çš„ session()ï¼Œå®Œæˆåç»­å·¥ä½œ`
* è·å–éªŒè¯ç å›¾ç‰‡æ—¶å€™è¦ä¿è¯è¯·æ±‚è·Ÿä¹‹å‰è·å–ç½‘é¡µæ—¶åŒä¸€ä¸ªï¼Œå³éœ€è¦ä½¿ç”¨ä¸Šä¸€ä¸ªè¯·æ±‚çš„ session()ï¼Œè€Œä¸æ˜¯å† requests
* ç™»å½•æ—¶å€™ä¹Ÿä¸èƒ½ä½¿ç”¨ requestsï¼Œä¹Ÿè¦ä½¿ç”¨ä¸Šä¸€ä¸ªè¯·æ±‚çš„ session()


```python
import requests
from lxml import etree
import urllib.request


# é€šè¿‡ç™»å½• è¿›å…¥é¡µé¢

# é€šè¿‡æ‰¾ç™»å½•æ¥å£å‘ç°ï¼Œéœ€è¦çš„
# __VIEWSTATE: oDcXaUXRxOCFJijd9bXX7NhNBNUxAGnzbxk4XOq715LrQpUCg=
# __VIEWSTATEGENERATOR: C93BE1AE
# from: http://
# email: 
# pwd: aaa111111
# code: 
# denglu: ç™»å½•

# æˆ‘ä»¬è§‚å¯Ÿåˆ° __VIEWSTATEã€__VIEWSTATEGENERATORã€code æ˜¯å¯å˜åŒ–çš„
# éš¾ç‚¹ 1ï¼š __VIEWSTATEã€__VIEWSTATEGENERATORï¼Œä¸€èˆ¬çœ‹ä¸åˆ°çš„æ•°æ®å¯ä»¥åœ¨é¡µé¢çš„æºä»£ç ä¸­æ‰¾åˆ°
# æˆ‘ä»¬è§‚å¯Ÿåˆ°è¿™ä¿©æ•°æ®åœ¨é¡µé¢çš„æºç ä¸­ï¼Œç„¶åè¿›è¡Œè§£æå°±å¯ä»¥è·å–
# æºç ä¸­çš„ <input type="hidden" name="__VIEWSTATE" id="__VIEWSTATE" value="pM5feH9xR3IXHSEUqlg+4Ap6ovm+H0xD1LeR55W=">
# type="hidden" è¯´æ˜æ˜¯éšè—åŸŸï¼Œä¸€èˆ¬å¤§çš„ç½‘ç«™å¯èƒ½éƒ½æœ‰éšè—åŸŸï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§åçˆ¬æ‰‹æ®µ
#
# éš¾åº¦ 2ï¼šéªŒè¯ç  code

# ç™»å½•é¡µé¢ url

headers = {
    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36'
}

login_url = ''

login_resp = requests.get(url=login_url, headers=headers)
login_content = login_resp.text
print(login_content)

login_tree = etree.HTML(login_content)
print(f'login_tree is {login_tree}')

# get __VIEWSTATE
view_state = login_tree.xpath('//input[@id="__VIEWSTATE"]/@value')[0]
print(f'view_state is {view_state}')

# get __VIEWSTATEGENERATOR
view_state_generator = login_tree.xpath('//input[@id="__VIEWSTATEGENERATOR"]/@value')[0]
print(f'view_state_generator is {view_state_generator}')

# è·å–éªŒè¯ç å›¾ç‰‡
code = login_tree.xpath('//img[@id="imgCode"]/@src')[0]
print(code)
code_url = '' + code
print(code_url)

# æœ‰å‘ï¼šå³ä½ åœ¨ urlretrieve éªŒè¯ç å°±å˜äº† å°±ä¸æ˜¯ç¬¬ä¸€æ¬¡æ‰“å¼€é¡µé¢æ—¶å€™çš„éªŒè¯ç äº†
# urllib.request.urlretrieve(url=code_url, filename='code.jpg')
#
# é‚£æ€ä¹ˆè§£å†³å‘¢ ï¼šï¼Ÿ
# requests é‡Œæœ‰ä¸€ä¸ªæ–¹æ³•å« session()ï¼Œé€šè¿‡ session çš„è¿”å›å€¼å°±èƒ½ä½¿è¯·æ±‚å˜ä¸ºä¸€ä¸ªå¯¹è±¡
session = requests.session()
# éªŒè¯ç çš„ url å†…å®¹
code_resp = session.get(code_url)
# æ³¨æ„æ­¤æ—¶è¦ä½¿ç”¨äºŒè¿›åˆ¶æ•°æ®, å› ä¸ºæˆ‘ä»¬è¦å›¾ç‰‡ä¸‹è½½ï¼Œå›¾ç‰‡ä¸‹è½½è¦ä½¿ç”¨äºŒè¿›åˆ¶
code_content = code_resp.content
# wb æ¨¡å¼å°±æ˜¯å°†äºŒè¿›åˆ¶å†™å…¥æ–‡ä»¶
with open('code.jpg', 'wb') as fp:
    fp.write(code_content)


# è·å–éªŒè¯ç çš„å›¾ç‰‡åä¸‹è½½åˆ°æœ¬åœ°ï¼Œç„¶åè§‚å¯ŸéªŒè¯ç ï¼Œè§‚å¯Ÿååœ¨æ§åˆ¶å°è¾“å…¥è¿™ä¸ªéªŒè¯ç 
# ç„¶åæŠŠè¿™ä¸ªå€¼ç»™ code å°±å¯ä»¥ç™»å½•äº†
code_name = input('è¯·è¾“å…¥ä½ çš„éªŒè¯ç ')

# å¦‚ä½•æ‰¾ç™»å½•æ¥å£
# æ–¹æ³• 1ï¼šç»™ä¸€ä¸ªé”™è¯¯çš„å¯†ç ï¼Œåœ¨å¼€å‘è€…å·¥å…·ä¸­æ‰¾
# æ–¹æ³• 2ï¼šå¦‚æœ chrome ç‰ˆæœ¬è¿‡ä½ï¼Œéœ€è¦æŠŠå¼€å‘è€…å·¥å…·ä¸­ï¼Œpreserve log å‹¾ä¸Šï¼Œä¸å‹¾çš„è¯å¯èƒ½ç™»å½•åå…¶æ¥å£ log å°±è¢«åˆ é™¤äº†

url = ''

data = {
    '__VIEWSTATE': view_state,
    '__VIEWSTATEGENERATOR': view_state_generator,
    'from': 'http://',
    'email': ,
    'pwd': '',
    'code': code_name,
    'denglu': 'ç™»å½•',
}

# è¿™é‡Œä¹Ÿä¸èƒ½ç”¨ requests è¦ç”¨ session è¦ä¿è¯æ˜¯åŒä¸€ä¸ªè¯·æ±‚
# resp = requests.post(url=url, data=data, headers=headers)
resp = session.post(url=url, data=data, headers=headers)

content = resp.text

with open('xxx.html', 'w', encoding='utf-8') as fp:
    fp.write(content)
```


