---
layout: post
title: RustGuide-16
date: 2023-04-10 16:45:30.000000000 +09:00
categories: [Rust]
tags: [Rust]
---

# 19 é«˜çº§ç‰¹æ€§

## Unsafe Rustï¼ˆä¸å®‰å…¨ Rustï¼‰

### åŒ¹é…å‘½åå˜é‡
* åœ¨ Rust ä¸­éšè—ç€ç¬¬äºŒä¸ªè¯­éŸ³ï¼Œå®ƒæ²¡æœ‰å¼ºåˆ¶å†…å­˜å®‰å…¨ä¿è¯ï¼Œå®ƒå°±æ˜¯ Unsafe Rust
* Unsafe Rust ä¸æ™®é€šçš„ Rust ä¸€æ ·ï¼Œä½†æä¾›äº†ä¸€äº› â€œè¶…èƒ½åŠ›â€
* Unsafe Rust å­˜åœ¨æ˜¯å› ä¸ºä»¥ä¸‹å‡ ä¸ªåŸå› 
1. é™æ€åˆ†ææ˜¯ä¿å®ˆçš„ï¼ˆå³å‡ºäºå®‰å…¨è€ƒè™‘ä¼šé”™è¯¯åˆ¤æ–­ä¸€äº›æƒ…å†µä¸ºä¸åˆæ³•ï¼‰ï¼Œè€Œä½¿ç”¨ Unsafe Rustï¼Œå³å‘Šè¯‰ç¼–è¯‘å™¨æˆ‘ä»¬çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆï¼Œå¹¶æ‰¿æ‹…ç›¸åº”é£é™©
2. è®¡ç®—æœºç¡¬ä»¶æœ¬èº«å°±æ˜¯ä¸å®‰å…¨çš„ï¼ŒRust éœ€è¦èƒ½å¤Ÿè¿›è¡Œåº•å±‚çš„ç³»ç»Ÿç¼–ç¨‹ï¼Œå¦‚æœä¸å…è®¸ Unsafe Rust é‚£ä¹ˆè¿™äº›å·¥ä½œå°±æ— æ³•å®Œæˆäº†

### Unsafe è¶…èƒ½åŠ›
* å¯ä»¥ä½¿ç”¨ unsafe å…³é”®å­—æ¥åˆ‡æ¢åˆ° Unsafe Rust æ¨¡å¼ï¼Œå®ƒä¼šåè¾¹è·Ÿç€ä¸€ä¸ªä»£ç å—ï¼Œåœ¨è¿™ä¸ªä»£ç å—é‡Œå†™çš„ä»£ç å°±æ˜¯ unsafe ä»£ç 
* Unsafe Rust é‡Œå¯æ‰§è¡Œ 4 ä¸ªåŠ¨ä½œï¼ˆè¶…èƒ½åŠ›ï¼‰
1. è§£å¼•ç”¨åŸå§‹æŒ‡é’ˆ
2. è°ƒç”¨ unsafe å‡½æ•°æˆ–æ–¹æ³•
3. è®¿é—®æˆ–ä¿®æ”¹å¯å˜çš„é™æ€å˜é‡
4. å®ç° unsafe trait

> unsafe å¹¶æ²¡æœ‰å…³é—­å€Ÿç”¨æ£€æŸ¥æˆ–åœç”¨å…¶ä»–çš„å®‰å…¨æ£€æŸ¥æªæ–½ï¼Œå¦‚æœä½ åœ¨ unsafe é‡Œä½¿ç”¨å¼•ç”¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå¼•ç”¨ä¾ç„¶ä¼šè¢«æ£€æŸ¥ï¼Œunsafe ä»…ä»…æ˜¯è®©ä½ å¯ä»¥è®¿é—®ä¸Šè¿° 4 ä¸ªç‰¹æ€§ï¼Œæ‰€ä»¥å³ä¾¿æ˜¯ unsafe ä¸­ä½ ä¾ç„¶ä¼šè·å¾—ä¸€å®šçš„å®‰å…¨æ€§ï¼Œé€šè¿‡æŠŠä¸Šè¾¹ 4 ç§ä¸å®‰å…¨æ“ä½œçº¦æŸåœ¨ unsafe ä»£ç å—ä¸­ï¼Œä½ å°±è¦çŸ¥é“ä»»ä½•å†…å­˜å®‰å…¨ç›¸å…³çš„é”™è¯¯å¿…é¡»ç•™åœ¨ unsafe å—é‡Œï¼Œå°½å¯èƒ½éš”ç¦» unsafe ä»£ç ï¼Œæœ€åå°†å…¶å°è£…åœ¨å®‰å…¨çš„æŠ½è±¡é‡Œï¼Œæä¾›å®‰å…¨çš„ APIã€‚å®é™…ä¸ŠæŸäº›æ ‡å‡†åº“å°±ä½¿ç”¨äº† unsafe ä»£ç ï¼Œä½†ä»–ä»¬åœ¨è¿™ä¹‹ä¸Šåˆæä¾›äº†å®‰å…¨çš„æŠ½è±¡æ¥å£ï¼Œå› ä¸ºä½¿ç”¨å®‰å…¨çš„æŠ½è±¡æ˜¯å®‰å…¨çš„ã€‚
{: .prompt-info }


### 1 è§£å¼•ç”¨åŸå§‹æŒ‡é’ˆ
* åœ¨ Unsafe Rust é‡Œæœ‰ä¸¤ç§ç±»ä¼¼äºå¼•ç”¨çš„æ–°å‹æŒ‡é’ˆï¼Œå®ƒä»¬å«åŸå§‹æŒ‡é’ˆï¼ˆæˆ–å«è£¸æŒ‡é’ˆè‹±æ–‡æ˜¯ Raw Pointerï¼‰
1. ä¸å¼•ç”¨ç±»ä¼¼ï¼Œå®ƒè¦ä¹ˆæ˜¯å¯å˜çš„ï¼Œè¦ä¹ˆæ˜¯ä¸å¯å˜çš„
2. å¯å˜çš„ï¼Œè¯­æ³•æ˜¯ `*mut T`
3. ä¸å¯å˜çš„ï¼Œè¯­æ³•æ˜¯ `*const T`ï¼Œæ„å‘³ç€æŒ‡é’ˆåœ¨è§£å¼•ç”¨ä¹‹åä¸èƒ½ç›´æ¥å¯¹å…¶è¿›è¡Œèµ‹å€¼

> è¿™é‡Œ * ä¸æ˜¯è§£å¼•ç”¨ç¬¦å·ï¼Œå®ƒæ˜¯ç±»å‹åçš„ä¸€éƒ¨åˆ†
{: .prompt-info }


#### åŸå§‹æŒ‡é’ˆä¸å¼•ç”¨çš„åŒºåˆ«
1. åŸå§‹æŒ‡é’ˆå¯å¿½ç•¥å€Ÿç”¨è§„åˆ™ï¼Œå³å…è®¸é€šè¿‡åŒæ—¶å…·æœ‰ä¸å¯å˜å’Œå¯å˜æŒ‡é’ˆæˆ–å¤šä¸ªæŒ‡å‘åŒä¸€ä½ç½®çš„å¯å˜æŒ‡é’ˆ
2. åŸå§‹æŒ‡é’ˆæ— æ³•ä¿è¯èƒ½æŒ‡å‘åˆç†çš„å†…å­˜ï¼Œè€Œå¼•ç”¨æ€»æ˜¯æŒ‡å‘åˆç†çš„å†…å­˜
3. åŸå§‹æŒ‡é’ˆå…è®¸ä¸º null
4. åŸå§‹æŒ‡é’ˆä¸å®ç°ä»»ä½•è‡ªåŠ¨æ¸…ç†

* åœ¨æ”¾å¼ƒè¿™äº›å®‰å…¨çš„ä¿è¯åï¼Œå°±å¯ä»¥æ¢å–æ›´å¥½çš„æ€§èƒ½ä»¥åŠä¸å…¶ä»–è¯­è¨€æˆ–ç¡¬ä»¶æ¥å£çš„èƒ½åŠ›äº†

```rust
fn main() {
    let mut num = 5;

    /*
        åœ¨ unsafe ä»£ç å—ä¹‹å¤–åˆ›å»ºåŸå§‹æŒ‡é’ˆ
        ä½†åªèƒ½åœ¨ unsafe ä»£ç å—ä¸­å¯¹åŸå§‹æŒ‡é’ˆè§£å¼•ç”¨
    */
    // å°†ä¸å¯å˜å¼•ç”¨è½¬ä¸ºä¸å¯å˜åŸå§‹æŒ‡é’ˆï¼Œè¿™æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„åŸå§‹æŒ‡é’ˆ
    let r1 = &num as *const i32;

    // å°†å¯å˜å¼•ç”¨è½¬ä¸ºå¯å˜åŸå§‹æŒ‡é’ˆï¼Œè¿™æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„åŸå§‹æŒ‡é’ˆ
    let r2 = &mut num as *mut i32;

    // å¯¹åŸå§‹æŒ‡é’ˆè§£å¼•ç”¨
    unsafe {
        println!("r1: {}", *r1);
        println!("r2: {}", *r2);   

        // å¯ä»¥ç”¨ r2 ä¿®æ”¹å…¶å€¼ï¼Œè¿™éœ€è¦å¤šåŠ å°å¿ƒ
        *r2 = 3; 
        println!("r2: change to {}", *r2);   
    }

    /*
        åˆ›å»ºä¸€ä¸ªæ— æ³•çŸ¥é“å…¶æœ‰æ•ˆæ€§çš„åŸå§‹æŒ‡é’ˆ
        åŸå§‹æŒ‡é’ˆä¸ä¸€å®šä¸€ç›´æœ‰æ•ˆ

        è¿™ä¸ªå†…å­˜åœ°å€å¯èƒ½æœ‰æ•°æ®ï¼Œä¹Ÿå¯èƒ½æ²¡æœ‰æ•°æ®ï¼Œè¿™æ ·ä¾ç„¶å¯ä»¥åˆ›å»ºä¸€ä¸ªåŸå§‹æŒ‡é’ˆ
        address å¯èƒ½æ˜¯æ— æ•ˆçš„
     */
    let address = 0x1245usize;
    let r = address as *const i32;
    // å¯¹åŸå§‹æŒ‡é’ˆè§£å¼•ç”¨
    unsafe {
        println!("r: {}", *r);
    }

}
```

#### ä½¿ç”¨åŸå§‹æŒ‡é’ˆçš„åŸå› 
1. ä¸ C è¯­è¨€è¿›è¡Œæ¥å£äº¤äº’
2. æ„å»ºå€Ÿç”¨æ£€æŸ¥å™¨æ— æ³•ç†è§£çš„å®‰å…¨æŠ½è±¡


### 2 è°ƒç”¨ unsafe å‡½æ•°æˆ–æ–¹æ³•
* unsafe å‡½æ•°æˆ–æ–¹æ³•ï¼Œå³åœ¨å®ƒä»¬å‰è¾¹åŠ ä¸Šäº† unsafe å…³é”®å­—çš„å‡½æ•°æˆ–æ–¹æ³•
* è°ƒç”¨å®ƒä»¬å‰éœ€è¦æ»¡è¶³ä¸€äº›æ¡ä»¶ï¼ˆä¸»è¦é çœ‹æ–‡æ¡£ï¼‰ï¼Œå› ä¸º Rust æ— æ³•å¯¹è¿™äº›æ¡ä»¶è¿›è¡ŒéªŒè¯
* è°ƒç”¨ unsafe å‡½æ•°æˆ–æ–¹æ³•ï¼Œå¿…é¡»åœ¨ unsafe å—é‡Œè°ƒç”¨
* unsafe å‡½æ•°æˆ–æ–¹æ³•ä¹Ÿå±äº unsafe å—

```rust

unsafe fn dangerous() {
    println!("I am dangerous !");
}

fn main() {

    // è°ƒç”¨ Unsafe å‡½æ•°éœ€è¦å† Unsafe å—é‡Œ
    unsafe {
        dangerous();
    }

}
```

#### åˆ›å»º unsafe ä»£ç çš„å®‰å…¨æŠ½è±¡
* å‡½æ•°åŒ…å« unsafe ä»£ç å¹¶ä¸æ„å‘³ç€éœ€è¦å°†æ•´ä¸ªå‡½æ•°æ ‡è®°ä¸º unsafe
* å°† unsafe ä»£ç åŒ…è£¹åœ¨å®‰å…¨å‡½æ•°ä¸­æ˜¯ä¸€ç§å¸¸è§çš„æŠ½è±¡

ä¸‹è¾¹ä»£ç è®©æˆ‘ä»¬çœ‹çœ‹æ ‡å‡†åº“æä¾› split_at_mut å‡½æ•°æ˜¯å¦‚ä½•å®ç°çš„

```rust
/*
    ç®€å•å®šä¹‰ split_at_mut çœ‹çœ‹å…¶å®ç°çš„åŸç†
 */
// fn split_at_mut_demo(slice: &mut [i32], mid: usize) 
// -> (&mut [i32], &mut [i32]) {
//     let len = slice.len();

//     assert!(mid <= len);
//     // è¿™é‡ŒæŠ¥é”™ï¼Œå› ä¸ºè¿åäº†å€Ÿç”¨è§„åˆ™, ä¿®æ­£éœ€è¦ä½¿ç”¨ unsafe code
//     (&mut slice[..mid], &mut slice[mid..])
// }


/*
    è‡ªå·±å®ç° split_at_mut 
    
    ä½¿ç”¨ unsafe ä»£ç ä¿®æ­£ split_at_mut_demo
    split_at_mut é‡Œä½¿ç”¨äº† unsafe ä»£ç ï¼Œä½†æ˜¯å…¶å‡½æ•°
    æœ¬èº«æ²¡æœ‰æ ‡è®°ä¸º unsafe æ‰€ä»¥ split_at_mut å°±æ˜¯ä¸€ä¸ª
    unsafe å®‰å…¨æŠ½è±¡ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»å®‰å…¨çš„ä»£ç ä¸­å¯¹å…¶è¿›è¡Œè°ƒç”¨
 */
fn split_at_mut(slice: &mut [i32], mid: usize) 
-> (&mut [i32], &mut [i32]) {
    let len = slice.len();
    assert!(mid <= len);
    /*
        è¿™é‡Œè¿”å›ä¸€ä¸ªåŸå§‹æŒ‡é’ˆï¼Œå®ƒçš„ç±»å‹æ˜¯ *mut i32
        å®ƒæŒ‡å‘è¿™ä¸ªåˆ‡ç‰‡
     */
    let ptr = slice.as_mut_ptr();

    unsafe {
        /*
            from_raw_parts_mut æ¥æ”¶ä¸€ä¸ªåŸå§‹æŒ‡é’ˆå’Œä¸€ä¸ªé•¿åº¦æ¥åˆ›å»ºåˆ‡ç‰‡
            ptr.add(mid) è·å¾—ä»¥ mid ä¸ºåç§»é‡çš„åŸå§‹æŒ‡é’ˆ
         */
        (slice::from_raw_parts_mut(ptr, mid),
        slice::from_raw_parts_mut(ptr.add(mid), len - mid)
        )
    }

}

fn main() {
    let mut v = vec![1, 2, 3, 4, 5, 6];
    // r æ˜¯ v çš„å®Œæ•´çš„ slice
    let r = &mut v[..];
    /*
        æ ‡å‡†åº“æä¾› split_at_mut å‡½æ•°ï¼Œ
        å°†å‚æ•° index ä¸ºç•Œé™ï¼Œ
        åˆ†éš”æˆä¸¤ä¸ªåˆ‡ç‰‡
        split_at_mut å®é™…æ˜¯ä½¿ç”¨äº†ä¸å®‰å…¨çš„ä»£ç 
     */
    let (a, b) = split_at_mut(r, 3);
    //let (a, b) = r.split_at_mut(3);

    assert_eq!(a, &mut [1, 2, 3]);
    assert_eq!(b, &mut [4, 5, 6]); 
}
```


```rust
fn main() {
    println!("test_address");
    let address = 0x12345usize;
    let r = address as *mut i32;
    // è¿™æ ·å¯èƒ½ crash å› ä¸ºæ— æ³•ä¿è¯æ‹¥æœ‰ 10000 å…ƒç´ çš„åˆ‡ç‰‡æ˜¯æœ‰æ•ˆçš„
    let slice: &[i32] = unsafe {
        slice::from_raw_parts_mut(r, 10000)
    }; 
}
```

### ä½¿ç”¨ extern å‡½æ•°è°ƒç”¨å¤–éƒ¨ä»£ç 
* extern å…³é”®å­—å¯ä»¥ç®€åŒ–åˆ›å»ºå’Œä½¿ç”¨å¤–éƒ¨å‡½æ•°æ¥å£ï¼ˆFFIï¼‰çš„è¿‡ç¨‹
* å¤–éƒ¨å‡½æ•°æ¥å£ï¼ˆFFIï¼ŒForeign Function Interfaceï¼‰ï¼Œå®ƒå…è®¸ä¸€ç§ç¼–ç¨‹è¯­è¨€å®šä¹‰å‡½æ•°ï¼Œå¹¶è®©å…¶ä»–çš„ç¼–ç¨‹è¯­è¨€èƒ½è°ƒç”¨è¿™äº›å‡½æ•°

> ä»»ä½•åœ¨ `extern` å—é‡Œå£°æ˜çš„å‡½æ•°éƒ½æ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸ºå…¶ä»–è¯­è¨€å¹¶ä¸ä¼šéµå®ˆ Rust çš„è§„åˆ™ï¼Œè€Œ Rust åˆæ— æ³•å¯¹ä»–ä»¬è¿›è¡Œæ£€æŸ¥
{: .prompt-info }

æ‰€ä»¥åœ¨è°ƒç”¨å¤–éƒ¨å‡½æ•°æ—¶çš„å®‰å…¨é—®é¢˜è½åœ¨äº†å¼€å‘è€…èº«ä¸Š


```rust
/*
    extern "C" å—å†…çš„å‡½æ•°ç­¾åå°±æ˜¯æˆ‘ä»¬æƒ³è°ƒç”¨çš„å¤–éƒ¨å‡½æ•°çš„ç­¾å
    è€Œ "C" æŒ‡æ˜äº†å¤–éƒ¨å‡½æ•°ä½¿ç”¨çš„æ˜¯åº”ç”¨ç¨‹åºäºŒè¿›åˆ¶æ¥å£ï¼ˆABIï¼‰ï¼Œ
    ABI æ˜¯ç”¨äºå®šä¹‰åœ¨æ±‡ç¼–å±‚é¢çš„è°ƒç”¨æ–¹å¼çš„
 */ 
extern "C" {
    fn abs(input:i32) -> i32;
}

fn main() {
    unsafe {
        println!("Absolute value of -3 according to C: {}", abs(-3));
    }
}
```

* ABI æ˜¯ç”¨äºå®šä¹‰åœ¨æ±‡ç¼–å±‚é¢çš„è°ƒç”¨æ–¹å¼çš„
* "C" ABI æ˜¯æœ€å¸¸è§çš„ï¼Œå®ƒéµå¾ª C è¯­è¨€çš„ ABI

### ä»å…¶ä»–è¯­è¨€æ¥è°ƒç”¨ Rust å‡½æ•°
* å¯ä»¥ä½¿ç”¨ extern å…³é”®å­—æ¥åˆ›å»ºæ¥å£ï¼Œå…¶ä»–è¯­è¨€é€šè¿‡å®ƒä»¬å¯ä»¥è°ƒç”¨ Rust å‡½æ•°
* åœ¨ `fn` å‰è¾¹æ·»åŠ  `extern` å…³é”®å­—ï¼Œå¹¶æŒ‡å®šå¯¹åº”çš„ ABIã€‚å¹¶ä¸”è¿˜éœ€è¦æ·»åŠ  `#[no_mangle]` æ³¨è§£ï¼Œé¿å… Rust åœ¨ç¼–è¯‘æ—¶æ”¹å˜å®ƒçš„åç§°
1. mangle å®é™…å¯¹åº”ç¼–è¯‘çš„ä¸€ä¸ªé˜¶æ®µï¼Œåœ¨è¿™ä¸ªé˜¶æ®µç¼–è¯‘å™¨ä¼šä¿®æ”¹å‡½æ•°çš„åç§°ä»è€Œè®©å…¶åŒ…å«æ›´å¤šå¯ç”¨äºåç»­ç¼–è¯‘çš„ä¿¡æ¯ï¼Œè¿™äº›æ”¹å˜åçš„åç§°é€šå¸¸æ˜¯éš¾ä»¥é˜…è¯»çš„

```rust
// è¿™ä¸ªå‡½æ•°åœ¨ç¼–è¯‘é“¾æ¥åå°±å¯ä»¥è¢« C è¯­è¨€è®¿é—®äº†
// è¿™ç±»çš„ extern åŠŸèƒ½ä¸éœ€è¦ä½¿ç”¨ unsafe

#[no_mangle]
pub extern "C" fn call_from_c() {
    println!("Just call a rust function from C!");
}
```

### 3. è®¿é—®æˆ–ä¿®æ”¹ä¸€ä¸ªå¯å˜çš„é™æ€å˜é‡
* Rust æ”¯æŒå…¨å±€å˜é‡ï¼Œä½†å› ä¸ºæ‰€æœ‰æƒæœºåˆ¶å¯èƒ½äº§ç”ŸæŸäº›é—®é¢˜ï¼Œä¾‹å¦‚æ•°æ®ç«äº‰
* åœ¨ Rust ä¸­å…¨å±€å˜é‡å«é™æ€ï¼ˆstaticï¼‰å˜é‡


```rust
/*
    å‘½åè§„èŒƒå¤§å†™ï¼Œå£°æ˜æ—¶éœ€è¦æ ‡è¯†ç±»å‹
    é™æ€å˜é‡åªèƒ½å­˜å‚¨æ‹¥æœ‰ 'static è¿™ä¸ªç”Ÿå‘½å‘¨æœŸçš„å¼•ç”¨
    è¿™å°±æ„å‘³ç€ Rust å¯ä»¥è‡ªå·±æ¨æ–­å‡ºå…¶ç”Ÿå‘½å‘¨æœŸ
    æ‰€ä»¥å°±æ— éœ€æ‰‹åŠ¨æ ‡æ³¨äº†

 */
static HELLO_WORLD: &str = "Hello, world!";
fn main() {
    println!("name is {}", HELLO_WORLD);
}
```

#### é™æ€å˜é‡
* é™æ€å˜é‡ä¸å¸¸é‡ç±»ä¼¼
* å‘½åè§„èŒƒæ˜¯å¤§å†™çš„ SCREAMING_SNAKE_CASE
* å£°æ˜æ—¶å€™å¿…é¡»æ ‡æ³¨ç±»å‹
* é™æ€å˜é‡åªèƒ½å­˜å‚¨ `'static` ç”Ÿå‘½å‘¨æœŸçš„å¼•ç”¨ï¼Œæ— éœ€æ˜¾ç¤ºæ ‡æ³¨ï¼Œå› ä¸ºå¯ä»¥æ¨æ–­å‡ºæ¥
* è®¿é—®ä¸å¯å˜çš„é™æ€å˜é‡æ˜¯å®‰å…¨çš„

#### å¸¸é‡å’Œä¸å¯å˜é™æ€å˜é‡çš„åŒºåˆ«
* é™æ€å˜é‡ï¼šæœ‰å›ºå®šçš„å†…å­˜åœ°å€ï¼Œä½¿ç”¨å®ƒçš„å€¼æ€»ä¼šè®¿é—®åŒæ ·çš„æ•°æ®
* å¸¸é‡ï¼šå…è®¸ä½¿ç”¨å®ƒä»¬çš„æ—¶å€™å¯¹æ•°æ®è¿›è¡Œå¤åˆ¶
* é™æ€å˜é‡ï¼šæ˜¯å¯ä»¥æ”¹å˜çš„ï¼Œè®¿é—®å’Œä¿®æ”¹å¯å˜çš„é™æ€å˜é‡æ˜¯ä¸å®‰å…¨ï¼ˆunsafeï¼‰çš„æ“ä½œ

```rust
static mut COUNTER: u32 = 0;

fn add_to_count(inc: u32) {
    // è®¿é—®å’Œä¿®æ”¹å¯å˜çš„é™æ€å˜é‡æ˜¯ä¸å®‰å…¨ï¼ˆunsafeï¼‰çš„æ“ä½œ
    // æ‰€ä»¥è¿™é‡Œæ”¾åˆ° unsafe å—é‡Œè¿›è¡Œæ“ä½œ
    unsafe {
        COUNTER += inc;
    }
}

fn main() {
    add_to_count(3);

    unsafe {
        println!("COUNTER: {}", COUNTER);
    }
}
```

### 4. å®ç° unsafe trait
* å½“æŸä¸ª trait ä¸­å­˜åœ¨è‡³å°‘ä¸€ä¸ªæ–¹æ³•æ‹¥æœ‰ç¼–è¯‘å™¨æ— æ³•æ ¡éªŒçš„ä¸å®‰å…¨å› ç´ æ—¶ï¼Œå°±ç§°è¿™ä¸ª trait æ˜¯ä¸å®‰å…¨çš„
* å£°æ˜ä¸å®‰å…¨çš„ traitï¼šå³åœ¨ trait å‰åŠ  unsafe å…³é”®å­—
1. è¯¥ trait åªèƒ½åœ¨ unsafe ä»£ç å—ä¸­å®ç°

```rust
unsafe trait Foo {
    // methods go here
}

// åœ¨ unsafe ä»£ç å—ä¸­å®ç°
unsafe impl Foo for i32 {
    // method implementations go here
}
```

### ä½•æ—¶ä½¿ç”¨ unsafe ä»£ç 
* ç¼–è¯‘å™¨æ— æ³•ä¿è¯å†…å­˜å®‰å…¨ï¼Œè®©å¼€å‘è€…ä¿è¯ unsafe ä»£ç æ­£ç¡®å¹¶ä¸æ˜¯ä¸€ä¸ªç®€å•æ´»å„¿
* ä½†åˆå……è¶³ç†ç”±ä½¿ç”¨ unsafe ä»£ç æ—¶ï¼Œå°±å¯ä»¥ä½¿ç”¨
* é€šè¿‡æ˜¾ç¤ºæ ‡è®°çš„ unsafeï¼Œå¯ä»¥åœ¨å‡ºç°é—®é¢˜æ—¶è½»æ¾å®šä½


## é«˜çº§ Trait

### åœ¨ trait çš„å®šä¹‰ä¸­ä½¿ç”¨å…³è”ç±»å‹æ¥æŒ‡å®šå ä½ç±»å‹
* å…³è”ç±»å‹ï¼ˆassociated typeï¼‰æ˜¯ trait ä¸­ç±»å‹çš„å ä½ç¬¦ï¼Œå®ƒå¯ä»¥ç”¨åœ¨ trait çš„æ–¹æ³•ç­¾åä¸­
1. å³å¯ä»¥å®šä¹‰å‡ºåŒ…å«æŸäº›ç±»å‹çš„ traitï¼Œè€Œåœ¨å®ç°å‰æ— éœ€çŸ¥é“è¿™äº›ç±»å‹å…·ä½“æ˜¯ä»€ä¹ˆ
2. swift ä¹Ÿæœ‰è¿™ä¸ªç‰¹æ€§ 

* æ ‡å‡†åº“çš„ Iterator å°±ä½¿ç”¨äº† associated type
```rust
pub trait Iterator {
    type Item;

    fn next(&mut self) -> Option<Self::Item>;
}
```

### å…³è”ç±»å‹ä¸æ³›å‹çš„åŒºåˆ«
* æ³›å‹
1. æ¯æ¬¡å®ç° trait æ—¶å¿…é¡»æ ‡æ³¨å…·ä½“çš„ç±»å‹
2. å¯ä»¥ä¸ºä¸€ä¸ªç±»å‹å¤šæ¬¡å®ç°æŸä¸ª traitï¼ˆå³ä½¿ç”¨ä¸åŒçš„æ³›å‹å‚æ•°ï¼‰

```rust
pub trait Iterator2<T> {
    fn next(&mut self) -> Option<T>;
}

struct Counter {

}

//å¤šæ¬¡å®ç°æŸä¸ª Iterator2 trait for String
impl Iterator2<String> for Counter {
    fn next(&mut self) -> Option<String> {
        None
    }
}

//å¤šæ¬¡å®ç°æŸä¸ª Iterator2 trait for u32
impl Iterator2<u32> for Counter {
    fn next(&mut self) -> Option<u32> {
        None
    }
}
```

* å…³è”ç±»å‹
1. åœ¨ä½¿ç”¨ trait æ—¶ï¼Œæ— éœ€æ ‡æ³¨ç±»å‹ï¼Œä½†éœ€è¦åœ¨é‡Œè¾¹æŒ‡æ˜å…³è”çš„ç±»å‹
2. æ— æ³•ä¸ºå•ä¸ªç±»å‹å¤šæ¬¡å®ç°æŸä¸ª trait


```rust
pub trait Iterator {
    type Item;

    fn next(&mut self) -> Option<Self::Item>;
}

struct Counter {

}

impl Iterator for Counter {
    type Item = u32;
    fn next(&mut self) -> Option<Self::Item> {
        None
    }
}
```

> è¿™ä¸ª Iterator trait åªèƒ½ä¸º Counter ç±»å‹å®ç°ä¸€æ¬¡ï¼Œå¤šæ¬¡ä¼šæŠ¥é”™
{: .prompt-info }


### é»˜è®¤æ³›å‹å‚æ•°å’Œè¿ç®—ç¬¦é‡è½½
* å¯ä»¥åœ¨ä½¿ç”¨æ³›å‹å‚æ•°æ—¶ä¸ºæ³›å‹æŒ‡å®šä¸€ä¸ªé»˜è®¤çš„å…·ä½“ç±»å‹
* è¯­æ³•ï¼š`<PlaceholderType=ConcreteType>`ï¼ŒConcreteType å°±æ˜¯é»˜è®¤çš„ç±»å‹
* è¿™ç§æŠ€æœ¯å¸¸ç”¨äºè¿ç®—ç¬¦é‡è½½ï¼ˆoperator overloadingï¼‰

> è™½ç„¶ Rust ä¸å…è®¸åˆ›å»ºè‡ªå·±çš„è¿ç®—ç¬¦ä»¥åŠé‡è½½ä»»æ„çš„è¿ç®—ç¬¦ã€‚ä½†å¯ä»¥é€šè¿‡å®ç° `std::ops` ä¸­åˆ—å‡ºçš„é‚£äº› trait æ¥é‡è½½ä¸€éƒ¨åˆ†ç›¸åº”çš„è¿ç®—ç¬¦
{: .prompt-info }


è¿™é‡Œé‡è½½äº† `+` è¿ç®—ç¬¦
```rust
use std::ops::Add;

#[derive(Debug, PartialEq)]
struct Point {
    x: i32,
    y: i32,
}

impl Add for Point {
    type Output = Point;

    fn add(self, rhs: Self) -> Self::Output {
        Point {
            x: self.x + rhs.x,
            y: self.y + rhs.y,
        }
    }
}

fn main() {

    assert_eq!(Point { x: 1, y: 0} + Point { x: 2, y: 3},
               Point {x: 3,y: 3});
    println!("point add");
}
```

* `pub trait Add<Rhs = Self>`ï¼ŒAdd è¿™é‡Œå°±ä½¿ç”¨äº†é»˜è®¤çš„æ³›å‹å‚æ•°ç±»å‹ï¼Œå³å¦‚æœåœ¨ä½¿ç”¨ trait æ—¶æ²¡æœ‰æŒ‡å®šé»˜è®¤æ³›å‹å‚æ•°ç±»å‹åˆ™ä½¿ç”¨ Self ä½œä¸ºé»˜è®¤ç±»å‹ï¼Œ
æ‰€ä»¥ä¸Šè¾¹ä»£ç ä¸­ Self å°±æ˜¯ Point


#### è‡ªå·±æŒ‡å®šé»˜è®¤æ³›å‹å‚æ•°ç±»å‹

* ä¸º Millimeters å®ç° Add traitï¼Œè®©æ¯«ç±³ä¸ç±³å¯ä»¥ç›¸åŠ 

```rust
use std::ops::Add;

struct Millimeters(u32);
struct Meters(u32);

// è¿™é‡ŒæŒ‡å®šé»˜è®¤çš„æ³›å‹å‚æ•°ä¸º Meters
impl Add<Meters> for Millimeters {
    type Output = Millimeters;

    fn add(self, rhs: Meters) -> Self::Output {
        Millimeters(self.0 + (rhs.0 * 1000)) 
    }
}
```

#### é»˜è®¤æ³›å‹å‚æ•°çš„åº”ç”¨åœºæ™¯
* æ‰©å±•ä¸€ä¸ªç±»å‹è€Œä¸ç ´åç°æœ‰çš„ä»£ç 
* å…è®¸åœ¨å¤§éƒ¨åˆ†ç”¨æˆ·éƒ½ä¸éœ€è¦çš„ç‰¹å®šåœºæ™¯ä¸‹è¿›è¡Œè‡ªå®šä¹‰
1. ä¸Šè¾¹ Millimeters å’Œ Meters çš„ä¾‹å­å°±å±äºè‡ªå®šä¹‰


### å®Œå…¨é™å®šè¯­æ³•ï¼ˆFully Qualified Syntaxï¼‰å¦‚ä½•è°ƒç”¨åŒåæ–¹æ³•

```rust
trait Pilot {
    fn fly(&self);
}

trait Wizard {
    fn fly(&self);
}

struct Human;

impl Pilot for Human {
    fn fly(&self) {
        println!("This is your captain speaking.");
    }
}

impl Wizard for Human {
    fn fly(&self) {
        println!("Up!");
    }
}

impl Human {
    fn fly(&self) {
        println!("Human's fly");
    }
}

fn main() {
    let person = Human;
    person.fly();

    // è°ƒç”¨ Human çš„ Pilot å®ç°
    Pilot::fly(&person);
    
    Wizard::fly(&person);
}
```

* ä¸Šè¾¹ä»£ç æ¯”è¾ƒç®€å•è°ƒç”¨æ²¡æœ‰é—®é¢˜

```rust
trait Animal {
    fn baby_name() -> String;
}

struct Dog;

impl Dog {
    fn baby_name() -> String {
        String::from("Spot")
    }
}

impl Animal for Dog {
    fn baby_name() -> String {
        String::from("puppy")
    }
}

fn test_dog() {
    println!("A baby dog is called a {}", Dog::baby_name());

    // è¿™æ ·å°±ä¼šæŠ¥é”™ï¼Œå› ä¸ºæ— æ³•çŸ¥é“ä½¿ç”¨å“ªä¸ªç±»å‹çš„ Animal å®ç°
    println!("A baby dog is called a {}", Animal::baby_name());
}
```

* ä¸Šè¾¹ä»£ç è°ƒç”¨ `Animal::baby_name()` å°±ä¼šæŠ¥é”™ï¼Œå› ä¸ºæ— æ³•çŸ¥é“ä½¿ç”¨å“ªä¸ªç±»å‹çš„ Animal å®ç°
* è¿™æ—¶å¯ä»¥ä½¿ç”¨å®Œå…¨é™å®šè¯­æ³•äº†

#### å®Œå…¨é™å®šè¯­æ³•
* æ ¼å¼ï¼š`<Type as Trait>::function(receiver_if_method, netx_arg, ...);`
1. receiver_if_method æ˜¯æ¥æ”¶è€…
2. netx_arg æ˜¯å‡½æ•°å‚æ•°

* è¿™ç§è¯­æ³•å¯ä»¥åœ¨ä»»ä½•è°ƒç”¨å‡½æ•°æˆ–æ–¹æ³•çš„åœ°æ–¹ä½¿ç”¨
* å¹¶ä¸”å®ƒå…è®¸å¿½ç•¥é‚£äº›ä»å…¶ä»–ä¸Šä¸‹æ–‡èƒ½æ¨å¯¼å‡ºæ¥çš„éƒ¨åˆ†
* åªæœ‰å½“ Rust æ— æ³•åŒºåˆ†ä½ æœŸæœ›è°ƒç”¨å“ªä¸ªå…·ä½“å®ç°çš„æ—¶å€™ï¼Œæ‰éœ€è¦ä½¿ç”¨è¿™ç§è¯­æ³•ã€‚å› ä¸ºè¿™ç§è¯­æ³•å†™èµ·æ¥æ¯”è¾ƒéº»çƒ¦ ğŸ˜…

* æ”¹æˆ `<Dog as Animal>::baby_name()` å°±å¯ä»¥äº†

```rust
println!("A baby dog is called a {}", <Dog as Animal>::baby_name());
```

### ä½¿ç”¨ supertrait æ¥è¦æ±‚ trait é™„å¸¦å…¶ä»– trait çš„åŠŸèƒ½
* å°±æ˜¯ä¸€ä¸ª trait ç»§æ‰¿å¦å¤–ä¸€ä¸ª trait
* æœ‰æ—¶éœ€è¦åœ¨ä¸€ä¸ª trait ä¸­ä½¿ç”¨å…¶ä»– trait çš„åŠŸèƒ½
1. å³éœ€è¦é‚£ä¸ªé—´æ¥è¢«ä¾èµ–çš„ trait ä¹Ÿè¢«å®ç°

> é‚£ä¸ªè¢«é—´æ¥ä¾èµ–çš„ trait å°±æ˜¯å½“å‰ trait çš„ supertrait
{: .prompt-info }

```rust
use std::fmt;

trait OutlinePrint: fmt:: Display {
    fn outline_print(&self) {
        let output = self.to_string();
        let len = output.len();
        println!("{}", "*".repeat(len + 4));
        println!("*{}*", " ".repeat(len + 2));
        println!("* {} *", output);
        println!("*{}*", " ".repeat(len + 2));
        println!("{}", "*".repeat(len + 4));
    }
}

struct Point {
    x: i32,
    y: i32,
}

impl fmt::Display for Point  {
    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {
        write!(f, "({}, {})", self.x, self.y)
    }
}
```

### ä½¿ç”¨ `newtype` æ¨¡å¼åœ¨å¤–éƒ¨ç±»å‹ä¸Šå®ç°å¤–éƒ¨ trait
* å­¤å„¿è§„åˆ™ï¼šåªæœ‰å½“ trait æˆ–ç±»å‹å®šä¹‰åœ¨æœ¬åœ°çš„åŒ…å†…æ—¶ï¼Œæ‰èƒ½ä¸ºè¯¥ç±»å‹å®ç°è¿™ä¸ª trait
* ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ `newtype` æ¨¡å¼æ¥ç»•è¿‡å­¤å„¿è§„åˆ™
1. å³åˆ©ç”¨ tuple structï¼ˆå…ƒç»„ç»“æ„ä½“ï¼‰åˆ›å»ºä¸€ä¸ªæ–°çš„ç±»å‹


```rust
use std::fmt;
/*
    æˆ‘ä»¬æƒ³ä¸º Vec å®ç° Display è¿™ä¸ª trait
    è€Œ Vec å’Œ Display éƒ½å®šä¹‰åœ¨å¤–éƒ¨çš„åŒ…ä¸­ï¼Œ
    æ‰€ä»¥æˆ‘ä»¬æ— æ³•ç›´æ¥ä¸º Vec å®ç° Display è¿™ä¸ª trait

    é‚£ä¹ˆæ€ä¹ˆåšå‘¢ï¼Ÿ
    æˆ‘ä»¬å¯ä»¥æŠŠ Vec åŒ…è£¹åœ¨ struct Wrapper ä¸­
 */
// åŒ…è£¹ Vec ä»¥ä¾¿å®ç° Display trait
struct Wrapper(Vec<String>);

impl fmt::Display for Wrapper {
    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {
        /*
            å› ä¸º Wrapper æ˜¯ä¸€ä¸ª tuple struct å¯ä»¥é€šè¿‡ç´¢å¼•å°† Vec å–å‡º
         */
        write!(f, "[{}]", self.0.join(", "))
    }
}
```

## é«˜çº§ç±»å‹

### 1 ä½¿ç”¨ `newtype` æ¨¡å¼å®ç°ç±»å‹å®‰å…¨å’ŒæŠ½è±¡
* `newtype` æ¨¡å¼çš„ä½œç”¨ï¼š
1. å¯ç”¨äºé™æ€çš„ä¿è¯å„ç§å€¼ä¹‹é—´ä¸ä¼šæ··æ·†å¹¶è¡¨æ˜å€¼çš„å•ä½
2. ä¸ºç±»å‹çš„æŸäº›ç»†èŠ‚æä¾›æŠ½è±¡èƒ½åŠ›
3. å¯é€šè¿‡è½»é‡çº§çš„å°è£…æ¥éšè—å†…éƒ¨å®ç°ç»†èŠ‚

### 2 ä½¿ç”¨ç±»å‹åˆ«åæ¥åˆ›å»ºç±»å‹åŒä¹‰è¯
* Rust æä¾›äº†ç±»å‹åˆ«åçš„åŠŸèƒ½
1. å¯ä»¥ä¸ºç°æœ‰ç±»å‹ç”Ÿäº§å¦å¤–çš„åç§°ï¼ˆåŒä¹‰è¯ï¼‰
2. è¿™ä¸ªç±»å‹çš„åˆ«åå¹¶ä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç±»å‹

* ä½¿ç”¨ type å…³é”®å­—åˆ›å»ºç±»å‹åˆ«å
* åˆ«åçš„ä¸»è¦ç”¨é€”å°±æ˜¯å‡å°‘ä»£ç çš„å­—ç¬¦é‡å¤

```rust
use std::fmt;

// ç±»å‹åˆ«å 1
type Kilometers = i32;


// ç±»å‹åˆ«å 2
type Thunk = Box<dyn Fn() + Send + 'static>;

fn take_long_type(f: Thunk) {

}

fn return_long_type() -> Thunk {
    Box::new(|| println!("hi"))
}

// ç±»å‹åˆ«å 3

// ç”±äºè¿™ä¸ªå£°æ˜åœ¨ use std::io::Error ä¸­æ‰€ä»¥è¿™é‡Œéœ€è¦æ³¨é‡Š
//type Result<T> = Result<T, std::io::Error>;

// å¯ä»¥å†åˆ«åä¸€æ¬¡ï¼Œä»¥ä¾¿ç›´æ¥ä½¿ç”¨ Result<T>
type Result<T> = std::io::Result<T>;

pub trait Write {
    fn write(&mut self, buf: &[u8]) -> Result<usize>;

    fn flush(&mut self) -> Result<()>;

    fn write_all(&mut self, buf: &[u8]) -> Result<()>;
    fn write_fmt(&mut self, fmt: fmt::Arguments) -> Result<()>;

}

fn main() {
    let x: i32 = 5;
    let y: Kilometers = 5;
    println!("x + y = {}", x + y);

    //-----------
    let f: Thunk = Box::new(|| println!("hi"));
}
```

### 3 Never ç±»å‹
* æœ‰ä¸€ä¸ªåä¸º ! çš„ç‰¹æ®Šç±»å‹
1. å®ƒæ²¡æœ‰ä»»ä½•å€¼ï¼Œè¡Œè¯ç§°ä¸ºç©ºç±»å‹ï¼ˆempty typeï¼‰

* æˆ‘ä»¬å€¾å‘äºå«å®ƒ never ç±»å‹ï¼Œå› ä¸ºå®ƒåœ¨ä¸è¿”å›å€¼çš„å‡½æ•°ä¸­å……å½“è¿”å›ç±»å‹
* ä¸è¿”å›å€¼çš„å‡½æ•°ä¹Ÿè¢«ç§°ä½œå«å‘æ•£å‡½æ•°ï¼ˆdiverging functionï¼‰

```rust
// è¿™ä¸ªå‡½æ•°è¡¨ç¤ºè¿”å› Never ç±»å‹
// è¿™é‡ŒæŠ¥é”™ï¼Œä»€ä¹ˆä¸å†™è¿”å›çš„æ˜¯ `()`

// mismatched types
// expected type `!`
// found unit type `()`
fn bar() -> ! {

}
```



## é«˜çº§å‡½æ•°å’Œé—­åŒ…

## å®


